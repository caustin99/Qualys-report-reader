<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Qualys CSV Report Analyzer — ADM Styled</title>
  <style>
    :root {
      --adm-blue: #0033A0; /* ADM Blue */
      --adm-red:  #ED1C24; /* ADM Red  */
      --ink-900:  #1f2937; /* dark text */
      --ink-700:  #374151;
      --ink-500:  #6b7280;
      --ink-300:  #d1d5db;
      --bg-50:    #f9fafb;
      --bg-100:   #f3f4f6;
      --success:  #059669;
      --warn:     #f59e0b;
      --info:     #2563eb;
      --radius:   10px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.06);
      --shadow-md: 0 6px 20px rgba(0,0,0,0.08);
      --shadow-lg: 0 12px 30px rgba(0,0,0,0.10);
    }

    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif; /* Conor's preference */
      color: var(--ink-900);
      background: linear-gradient(180deg, #ffffff 0%, #f7f9ff 100%);
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 20px 60px;
    }

    /* Header */
    .app-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 18px;
    }

    .app-header img {
      height: 58px;
      width: auto;
      filter: drop-shadow(var(--shadow-sm));
    }

    .title-block h1 {
      margin: 0;
      font-size: 28px;
      color: var(--adm-blue);
      letter-spacing: 0.2px;
    }
    .title-block p {
      margin: 4px 0 0;
      color: var(--ink-500);
    }

    /* Card */
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: var(--radius);
      box-shadow: var(--shadow-md);
    }

    /* Uploader */
    .uploader { padding: 18px; margin-bottom: 20px; }

    .dropzone {
      border: 2px dashed var(--adm-blue);
      border-radius: var(--radius);
      background: #fff;
      padding: 24px;
      text-align: center;
      transition: background 220ms ease, border-color 220ms ease;
    }
    .dropzone.dragover {
      background: #eef3ff;
      border-color: var(--adm-red);
    }
    .dropzone h3 { margin: 0 0 8px; }
    .dropzone p { margin: 4px 0; color: var(--ink-500); }

    .actions { margin-top: 12px; }
    .btn {
      appearance: none; border: none; cursor: pointer;
      background: var(--adm-blue); color: #fff;
      padding: 10px 14px; border-radius: 8px;
      box-shadow: var(--shadow-sm);
      transition: transform 120ms ease, opacity 120ms ease, background 160ms ease;
      font-weight: 600;
    }
    .btn:hover { transform: translateY(-1px); opacity: 0.95; }
    .btn.secondary { background: #e5e7eb; color: var(--ink-900); }
    .btn.export { background: var(--adm-blue); }
    .btn.red { background: var(--adm-red); }

    /* Summary */
    .summary { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; padding: 18px; }
    .stat {
      border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; background: #fff;
    }
    .stat h4 { margin: 0 0 6px; color: var(--ink-500); font-weight: 600; font-size: 12px; text-transform: uppercase; letter-spacing: 0.4px; }
    .stat .value { font-size: 22px; font-weight: 700; color: var(--ink-900); }

    /* Filters */
    .filters { display: flex; gap: 10px; padding: 16px; align-items: center; flex-wrap: wrap; }
    .filters label { font-size: 12px; color: var(--ink-500); display: block; margin-bottom: 4px; }
    .filters select, .filters input[type="search"] {
      padding: 9px 10px; border: 1px solid #e5e7eb; border-radius: 8px; min-width: 160px;
      font-family: inherit;
    }
    .filters .spacer { flex: 1; }

    /* Table */
    .table-wrap { margin-top: 8px; padding: 0 16px 16px; }
    .table-scroll { overflow: auto; border: 1px solid #e5e7eb; border-radius: 12px; background: #fff; box-shadow: var(--shadow-md); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }

    thead th {
      position: sticky; top: 0; z-index: 2;
      background: var(--adm-blue); color: #fff; text-align: left; white-space: nowrap;
      border-bottom: 1px solid #dbe2ff;
    }

    th, td { padding: 12px 10px; border-right: 1px solid #eef2f7; }
    tr td:last-child, tr th:last-child { border-right: none; }

    tbody tr:nth-child(odd) { background: #fafbff; }
    tbody tr:hover { background: #f1f6ff; }

    .sortable { cursor: pointer; user-select: none; }
    .sortable .arrow { margin-left: 6px; opacity: 0.7; font-size: 11px; }

    /* Badges */
    .badge { display: inline-flex; align-items: center; padding: 4px 8px; border-radius: 999px; font-weight: 700; font-size: 12px; }
    .sev-5 { background: rgba(237,28,36,0.10); color: var(--adm-red); border: 1px solid rgba(237,28,36,0.35); }
    .sev-4 { background: rgba(245,158,11,0.10); color: #b45309; border: 1px solid rgba(245,158,11,0.35); }
    .sev-3 { background: rgba(37,99,235,0.10); color: #1d4ed8; border: 1px solid rgba(37,99,235,0.35); }
    .sev-2 { background: rgba(16,185,129,0.10); color: #047857; border: 1px solid rgba(16,185,129,0.35); }
    .sev-1 { background: rgba(107,114,128,0.10); color: #374151; border: 1px solid rgba(107,114,128,0.35); }

    .status { padding: 4px 8px; border-radius: 8px; font-weight: 600; font-size: 12px; }
    .st-active { background: rgba(0,51,160,0.08); color: var(--adm-blue); border: 1px solid rgba(0,51,160,0.3); }
    .st-fixed  { background: rgba(16,185,129,0.10); color: #065f46; border: 1px solid rgba(16,185,129,0.35); }

    /* Charts */
    .panel {
      display: grid; grid-template-columns: 1.2fr 1fr; gap: 14px; padding: 16px; align-items: stretch;
    }
    .panel .card { padding: 16px; }
    .chart-title { margin: 0 0 8px; color: var(--ink-700); font-size: 14px; }
    canvas { width: 100%; height: 220px; }

    /* Footer */
    footer { margin-top: 28px; color: var(--ink-500); text-align: center; font-size: 12px; }

    /* Responsive */
    @media (max-width: 900px) {
      .summary { grid-template-columns: repeat(2, 1fr); }
      .panel { grid-template-columns: 1fr; }
    }

    @media (max-width: 600px) {
      .filters select, .filters input[type="search"] { min-width: 120px; }
      .title-block h1 { font-size: 22px; }
    }

    /* Fade-in */
    .fade-in { opacity: 0; animation: fade 320ms ease forwards; }
    @keyframes fade { to { opacity: 1; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header with ADM Logo -->
    <header class="app-header">
      <img src="admlogo.png" alt="ADM Logo" />
      <div class="title-block">
        <h1>Qualys CSV Report Analyzer</h1>
        <p>Analyze and visualize your vulnerability scan data</p>
      </div>
    </header>

    <!-- Uploader -->
    <section class="card uploader fade-in" aria-labelledby="uploader-title">
      <div class="dropzone" id="dropzone">
        <h3 id="uploader-title">Upload Your Qualys CSV Report</h3>
        <p><strong>Drag &amp; Drop</strong> your CSV file here</p>
        <p>or</p>
        <div class="actions">
          <label class="btn secondary" for="fileInput">Browse Files</label>
          <input id="fileInput" type="file" accept=".csv" style="display:none" />
        </div>
        <p style="margin-top:8px; color:var(--ink-500)">Supported format: Qualys Vulnerability Scan Report (CSV)</p>
      </div>
    </section>

    <!-- Summary -->
    <section class="card fade-in">
      <div class="summary" id="summary">
        <div class="stat">
          <h4>Total Vulnerabilities</h4>
          <div class="value" id="stat-total">0</div>
        </div>
        <div class="stat">
          <h4>Active Vulnerabilities</h4>
          <div class="value" id="stat-active">0</div>
        </div>
        <div class="stat">
          <h4>Fixed Vulnerabilities</h4>
          <div class="value" id="stat-fixed">0</div>
        </div>
        <div class="stat">
          <h4>Affected Hosts</h4>
          <div class="value" id="stat-hosts">0</div>
        </div>
        <div class="stat">
          <h4>Last Import</h4>
          <div class="value" id="stat-import">–</div>
        </div>
      </div>
    </section>

    <!-- Charts / Panels -->
    <section class="panel fade-in" aria-label="Analytics panels">
      <div class="card">
        <h3 class="chart-title">Severity Distribution</h3>
        <canvas id="severityChart" height="220" aria-label="Bar chart of severities"></canvas>
      </div>
      <div class="card">
        <h3 class="chart-title">Top Vulnerable Hosts</h3>
        <ol id="topHosts" style="margin:0; padding-left: 18px; color: var(--ink-700)">
          <li>—</li>
        </ol>
      </div>
    </section>

    <!-- Filters -->
    <section class="card fade-in" aria-label="Filters">
      <div class="filters">
        <div>
          <label for="sevFilter">Severity</label>
          <select id="sevFilter">
            <option value="">All Severities</option>
            <option value="5">Critical (5)</option>
            <option value="4">High (4)</option>
            <option value="3">Medium (3)</option>
            <option value="2">Low (2)</option>
            <option value="1">Info (1)</option>
          </select>
        </div>
        <div>
          <label for="statusFilter">Status</label>
          <select id="statusFilter">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="fixed">Fixed</option>
          </select>
        </div>
        <div>
          <label for="hostFilter">Host</label>
          <select id="hostFilter">
            <option value="">All Hosts</option>
          </select>
        </div>
        <div class="spacer"></div>
        <div>
          <label for="searchBox">Search</label>
          <input id="searchBox" type="search" placeholder="Title, CVE, QID …" />
        </div>
        <button class="btn export" id="exportCsvBtn" title="Export filtered data as CSV">Export CSV</button>
        <button class="btn secondary" id="exportJsonBtn" title="Export filtered data as JSON">Export JSON</button>
      </div>
    </section>

    <!-- Table -->
    <section class="table-wrap fade-in" aria-labelledby="table-title">
      <h3 id="table-title" style="margin: 6px 0 8px; color: var(--ink-700);">Vulnerability Details</h3>
      <div class="table-scroll">
        <table id="vulnTable" aria-describedby="table-title">
          <thead>
            <tr>
              <th class="sortable" data-key="qid">QID <span class="arrow">⇅</span></th>
              <th class="sortable" data-key="title">Title <span class="arrow">⇅</span></th>
              <th class="sortable" data-key="severity">Severity <span class="arrow">⇅</span></th>
              <th class="sortable" data-key="status">Status <span class="arrow">⇅</span></th>
              <th class="sortable" data-key="host">Host <span class="arrow">⇅</span></th>
              <th class="sortable" data-key="ip">IP <span class="arrow">⇅</span></th>
              <th class="sortable" data-key="lastDetected">Last Detected <span class="arrow">⇅</span></th>
              <th class="sortable" data-key="cve">CVE ID <span class="arrow">⇅</span></th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="8" style="text-align:center; color: var(--ink-500); padding: 16px;">No data loaded. Import a Qualys CSV to begin.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <footer>
      <p>Qualys CSV Report Analyzer © 2025 • For demonstration purposes only</p>
    </footer>
  </div>

  <script>
    // --- Utilities ---------------------------------------------------------
    const $ = (sel, ctx = document) => ctx.querySelector(sel);
    const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));

    function toInt(x, def=0) { const n = parseInt(x, 10); return Number.isNaN(n) ? def : n; }
    function normalizeStatus(s='') { s = String(s).trim().toLowerCase(); if (!s) return ''; return s.includes('fix') ? 'fixed' : 'active'; }

    // Lightweight CSV parser supporting quoted fields with commas and newlines
    function parseCSV(text) {
      const rows = [];
      let i = 0, field = '', row = [], inQuotes = false;
      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i++; } // escaped quote
            else { inQuotes = false; }
          } else { field += c; }
        } else {
          if (c === '"') inQuotes = true;
          else if (c === ',') { row.push(field); field = ''; }
          else if (c === '\n') { row.push(field); rows.push(row); row = []; field = ''; }
          else if (c === '\r') { /* ignore */ }
          else { field += c; }
        }
        i++;
      }
      // push final field/row
      if (field.length || row.length) { row.push(field); rows.push(row); }
      return rows;
    }

    function mapHeaders(headers) {
      // Map common Qualys CSV header names to canonical keys used in the UI
      const map = {};
      headers.forEach((h, idx) => {
        const key = String(h).trim().toLowerCase();
        if (/^qid/.test(key)) map.qid = idx;
        else if (/^title/.test(key) || /vuln\s*title/.test(key)) map.title = idx;
        else if (/^severity/.test(key)) map.severity = idx;
        else if (/^status/.test(key)) map.status = idx;
        else if (/^host\s*name|^hostname|^dns|^asset/.test(key)) map.host = idx;
        else if (/^ip/.test(key)) map.ip = idx;
        else if (/last\s*detected|last_found|last\s*scan/i.test(key)) map.lastDetected = idx;
        else if (/^cve/.test(key)) map.cve = idx;
      });
      return map;
    }

    function rowToObj(row, map) {
      const o = {
        qid: row[map.qid] ?? '',
        title: row[map.title] ?? '',
        severity: toInt(row[map.severity] ?? ''),
        status: normalizeStatus(row[map.status] ?? ''),
        host: row[map.host] ?? '',
        ip: row[map.ip] ?? '',
        lastDetected: row[map.lastDetected] ?? '',
        cve: row[map.cve] ?? ''
      };
      // If severity text given, normalize e.g., "Critical"
      if (!o.severity && row[map.severity]) {
        const s = String(row[map.severity]).toLowerCase();
        const dict = { critical:5, high:4, medium:3, low:2, info:1 };
        o.severity = dict[s] || 0;
      }
      return o;
    }

    function formatDate(d) {
      if (!d) return '';
      // leave as-is; try to make it ISO-like
      const date = new Date(d);
      if (!isNaN(date.getTime())) return date.toISOString().slice(0,10);
      return d;
    }

    function badgeForSeverity(sev) {
      const cls = `sev-${sev}`; const label = {1:'Info',2:'Low',3:'Medium',4:'High',5:'Critical'}[sev] || sev;
      return `<span class="badge ${cls}">${label}</span>`;
    }

    function chipForStatus(st) {
      const cls = st === 'fixed' ? 'st-fixed' : 'st-active';
      const label = st ? (st[0].toUpperCase()+st.slice(1)) : '';
      return `<span class="status ${cls}">${label||'—'}</span>`;
    }

    // --- State -------------------------------------------------------------
    let DATA = [];
    let FILTERS = { severity:'', status:'', host:'', search:'', sortKey:'', sortDir: 'asc' };

    // --- Rendering ---------------------------------------------------------
    function renderTable() {
      const tbody = $('#tableBody');
      let rows = DATA.slice();

      // Filters
      if (FILTERS.severity) rows = rows.filter(r => String(r.severity) === FILTERS.severity);
      if (FILTERS.status) rows = rows.filter(r => r.status === FILTERS.status);
      if (FILTERS.host) rows = rows.filter(r => r.host === FILTERS.host);
      if (FILTERS.search) {
        const q = FILTERS.search.toLowerCase();
        rows = rows.filter(r =>
          String(r.qid).toLowerCase().includes(q) ||
          String(r.title).toLowerCase().includes(q) ||
          String(r.cve).toLowerCase().includes(q) ||
          String(r.ip).toLowerCase().includes(q)
        );
      }

      // Sort
      if (FILTERS.sortKey) {
        const { sortKey, sortDir } = FILTERS;
        rows.sort((a, b) => {
          let va = a[sortKey], vb = b[sortKey];
          // for date
          if (sortKey === 'lastDetected') {
            const da = new Date(va).getTime()||0; const db = new Date(vb).getTime()||0;
            return sortDir === 'asc' ? da - db : db - da;
          }
          // numeric sort for severity
          if (sortKey === 'severity') {
            return sortDir === 'asc' ? (a.severity - b.severity) : (b.severity - a.severity);
          }
          // default string compare
          va = String(va).toLowerCase(); vb = String(vb).toLowerCase();
          if (va < vb) return sortDir === 'asc' ? -1 : 1;
          if (va > vb) return sortDir === 'asc' ? 1 : -1;
          return 0;
        });
      }

      // Render
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color: var(--ink-500); padding: 16px;">No rows match your filters.</td></tr>`;
        return;
      }

      const html = rows.map(r => {
        const date = formatDate(r.lastDetected);
        return `<tr>
          <td>${r.qid || '—'}</td>
          <td>${escapeHtml(r.title) || '—'}</td>
          <td>${badgeForSeverity(r.severity||0)}</td>
          <td>${chipForStatus(r.status)}</td>
          <td>${escapeHtml(r.host) || '—'}</td>
          <td>${r.ip || '—'}</td>
          <td>${date || '—'}</td>
          <td>${escapeHtml(r.cve) || '—'}</td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    }

    function renderSummary() {
      const total = DATA.length;
      const active = DATA.filter(d => d.status === 'active').length;
      const fixed  = DATA.filter(d => d.status === 'fixed').length;
      const hosts = new Set(DATA.map(d => d.host).filter(Boolean)).size;
      $('#stat-total').textContent = total;
      $('#stat-active').textContent = active;
      $('#stat-fixed').textContent  = fixed;
      $('#stat-hosts').textContent  = hosts;
      $('#stat-import').textContent = new Date().toISOString().slice(0,10);
    }

    function renderFilters() {
      const hostSel = $('#hostFilter');
      const uniqueHosts = Array.from(new Set(DATA.map(d => d.host).filter(Boolean))).sort();
      hostSel.innerHTML = `<option value="">All Hosts</option>` + uniqueHosts.map(h => `<option value="${escapeHtml(h)}">${escapeHtml(h)}</option>`).join('');
    }

    // Simple bar chart drawing on Canvas
    function renderSeverityChart() {
      const canvas = document.getElementById('severityChart');
      const ctx = canvas.getContext('2d');
      const counts = [1,2,3,4,5].map(sev => DATA.filter(d => d.severity === sev).length);
      const labels = ['Info','Low','Medium','High','Critical'];
      const colors = ['#6b7280','#10b981','#2563eb','#f59e0b', '#ED1C24'];

      const W = canvas.width = canvas.clientWidth * devicePixelRatio;
      const H = canvas.height = canvas.clientHeight * devicePixelRatio;
      ctx.scale(devicePixelRatio, devicePixelRatio);
      ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);

      const pad = { l: 40, r: 12, t: 8, b: 32 };
      const innerW = canvas.clientWidth - pad.l - pad.r;
      const innerH = canvas.clientHeight - pad.t - pad.b;
      const max = Math.max(1, ...counts);
      const barW = innerW / counts.length * 0.6;

      // axis
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(pad.l, canvas.clientHeight - pad.b);
      ctx.lineTo(canvas.clientWidth - pad.r, canvas.clientHeight - pad.b);
      ctx.stroke();

      counts.forEach((v, i) => {
        const x = pad.l + i * (innerW / counts.length) + (innerW/counts.length - barW)/2;
        const h = max ? (v / max) * (innerH - 6) : 0;
        const y = canvas.clientHeight - pad.b - h;
        ctx.fillStyle = colors[i];
        ctx.fillRect(x, y, barW, h);
        // label
        ctx.fillStyle = '#111827';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(String(v), x + barW/2, y - 6);
        ctx.fillStyle = '#374151';
        ctx.fillText(labels[i], x + barW/2, canvas.clientHeight - pad.b + 16);
      });
    }

    function renderTopHosts() {
      const ol = $('#topHosts');
      const counts = {};
      DATA.forEach(d => {
        const h = d.host || '(unknown)';
        counts[h] = (counts[h]||0) + 1;
      });
      const items = Object.entries(counts).sort((a,b) => b[1]-a[1]).slice(0,5);
      ol.innerHTML = items.length ? items.map(([h,c]) => `<li><strong>${escapeHtml(h)}</strong> — ${c} vulns</li>`).join('') : '<li>—</li>';
    }

    function refreshAll() { renderTable(); renderSummary(); renderFilters(); renderSeverityChart(); renderTopHosts(); }

    // --- Import / Export ---------------------------------------------------
    function onFile(file) {
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const text = reader.result;
        const rows = parseCSV(text);
        if (!rows.length) return;
        const headers = rows[0];
        const map = mapHeaders(headers);
        const needed = ['qid','title','severity','status','host','ip','lastDetected','cve'];
        const hasAny = needed.some(k => k in map);
        if (!hasAny) {
          alert('Could not detect expected Qualys columns. Please ensure you exported the Vulnerability CSV with headers.');
          return;
        }
        DATA = rows.slice(1).filter(r => r.some(cell => String(cell).trim() !== '')).map(r => rowToObj(r, map));
        refreshAll();
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
      };
      reader.readAsText(file);
    }

    function exportCSV(rows) {
      if (!rows.length) { alert('No data to export.'); return; }
      const header = ['QID','Title','Severity','Status','Host','IP','Last Detected','CVE ID'];
      const body = rows.map(r => [r.qid, r.title, r.severity, r.status, r.host, r.ip, r.lastDetected, r.cve]);
      const csv = [header, ...body].map(r => r.map(cell => {
        const s = String(cell ?? '');
        if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
        return s;
      }).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'qualys_filtered.csv';
      a.click(); URL.revokeObjectURL(a.href);
    }

    function exportJSON(rows) {
      if (!rows.length) { alert('No data to export.'); return; }
      const blob = new Blob([JSON.stringify(rows, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'qualys_filtered.json';
      a.click(); URL.revokeObjectURL(a.href);
    }

    function getFilteredRowsForExport() {
      // reuse the filtering logic without re-sorting DOM
      let rows = DATA.slice();
      if (FILTERS.severity) rows = rows.filter(r => String(r.severity) === FILTERS.severity);
      if (FILTERS.status) rows = rows.filter(r => r.status === FILTERS.status);
      if (FILTERS.host) rows = rows.filter(r => r.host === FILTERS.host);
      if (FILTERS.search) {
        const q = FILTERS.search.toLowerCase();
        rows = rows.filter(r =>
          String(r.qid).toLowerCase().includes(q) ||
          String(r.title).toLowerCase().includes(q) ||
          String(r.cve).toLowerCase().includes(q) ||
          String(r.ip).toLowerCase().includes(q)
        );
      }
      return rows;
    }

    // --- Event wiring ------------------------------------------------------
    window.addEventListener('DOMContentLoaded', () => {
      // Drag & Drop
      const dz = document.getElementById('dropzone');
      dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
      dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
      dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragover'); onFile(e.dataTransfer.files[0]); });
      document.getElementById('fileInput').addEventListener('change', e => onFile(e.target.files[0]));

      // Filters
      document.getElementById('sevFilter').addEventListener('change', e => { FILTERS.severity = e.target.value; renderTable(); });
      document.getElementById('statusFilter').addEventListener('change', e => { FILTERS.status = e.target.value; renderTable(); });
      document.getElementById('hostFilter').addEventListener('change', e => { FILTERS.host = e.target.value; renderTable(); });
      document.getElementById('searchBox').addEventListener('input', e => { FILTERS.search = e.target.value.trim(); renderTable(); });

      // Sorting
      $$('#vulnTable thead th.sortable').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (FILTERS.sortKey === key) {
            FILTERS.sortDir = FILTERS.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            FILTERS.sortKey = key; FILTERS.sortDir = 'asc';
          }
          renderTable();
        });
      });

      // Exports
      document.getElementById('exportCsvBtn').addEventListener('click', () => exportCSV(getFilteredRowsForExport()));
      document.getElementById('exportJsonBtn').addEventListener('click', () => exportJSON(getFilteredRowsForExport()));
    });
  </script>
</body>
</html>